# Nomenklatura Development Session #003
**Date:** 2025-12-15

---

## Summary

This session focused on two major improvements:
1. **Fixed clickable character names** in briefing text
2. **Redesigned the Ladder view** as a top-down organizational chart (tree diagram)

Additionally, fixed a bug where the player was incorrectly shown as filling multiple positions simultaneously.

---

## Phase 1: Clickable Names Fix

### Problem
Character names in `BriefingPaperView` narrative text were not tappable, even though the `ClickableNarrativeText` component existed and worked correctly in `NarrativeEventView`.

### Solution
**File Modified:** `Views/Desk/BriefingPaperView.swift`

Replaced plain `Text()` with `ClickableNarrativeText`:

```swift
// Before (line 211):
Text(scenario.briefing)
    .font(theme.narrativeFontLarge)
    .foregroundColor(theme.inkBlack)
    .lineSpacing(7)

// After:
if let game = game {
    ClickableNarrativeText(
        text: scenario.briefing,
        game: game,
        font: theme.narrativeFontLarge,
        color: theme.inkBlack,
        lineSpacing: 7
    )
} else {
    Text(scenario.briefing)
        .font(theme.narrativeFontLarge)
        .foregroundColor(theme.inkBlack)
        .lineSpacing(7)
}
```

Also added `CharacterSheetOverlayModifier(game: game)` to handle tap events.

---

## Phase 2: Org Chart Redesign

### Design Decisions (User Confirmed)
1. **Orientation:** Top-down (General Secretary at top, entry at bottom)
2. **View Mode:** Replace ladder entirely with org chart
3. **Regional Track:** Separate side branch, visually distinct from capital tracks

### New Files Created

#### 1. `Views/Ladder/OrgChartNode.swift`
Individual position box component showing:
- Track icon for specialized positions
- Abbreviated position title
- Current holder name or "Vacant"
- "★ YOU" badge for player's position
- Color coding: red border for current, gold for achieved, dimmed for off-track

**Two variants:**
- `OrgChartNode` - Compact (90×60) for bureau grid
- `SharedPositionNode` - Wide (180×50) for apex/entry positions

#### 2. `Views/Ladder/OrgChartConnector.swift`
Connection line components:
- `VerticalConnector` - Single vertical line
- `HorizontalConnector` - Single horizontal line
- `BranchConnector` - One-to-many (apex to 6 bureaus)
- `MergeConnector` - Many-to-one (bureaus back to shared)
- `NodeConnector` - Between nodes in same column

Features:
- Highlighted path for player's track (red)
- Gold for achieved positions
- Standard tan for other paths

#### 3. `Views/Ladder/OrgChartView.swift`
Main organizational chart view with:
- Header with title "Party Hierarchy"
- Progress bar showing Standing, Position, and Track
- Scrollable tree structure (horizontal + vertical)
- Position detail sheet on tap

**Visual Structure:**
```
                    ┌─────────────────────┐
                    │  GENERAL SECRETARY  │  Index 8
                    └─────────┬───────────┘
                              │
                    ┌─────────┴───────────┐
                    │  DEPUTY GEN. SEC.   │  Index 7
                    └─────────┬───────────┘
                              │
    ┌───────┬───────┬────┬────┴────┬───────┬───────┐
    │  CC   │  CoM  │ SPB │  MFA   │Gosplan│  MPA  │ Index 6
    ├───────┼───────┼─────┼────────┼───────┼───────┤
    │       │       │     │        │       │       │ Index 5
    ├───────┼───────┼─────┼────────┼───────┼───────┤
    │       │       │     │        │       │       │ Index 4  │ REGIONAL
    ├───────┼───────┼─────┼────────┼───────┼───────┤          │ (side)
    │       │       │     │        │       │       │ Index 3  │
    ├───────┼───────┼─────┼────────┼───────┼───────┤          │
    │       │       │     │        │       │       │ Index 2  │
    └───────┴───────┴──┬──┴────────┴───────┴───────┘
                       │
              ┌────────┴────────┐
              │JUNIOR PRESIDIUM │  Index 1 (Branch Point)
              └────────┬────────┘
                       │
              ┌────────┴────────┐
              │  PARTY OFFICIAL │  Index 0 (Entry)
              └─────────────────┘
```

**Components:**
- `OrgChartProgressBar` - Shows standing, current position, track
- `PositionDetailSheet` - Modal with requirements, holders, description

### Files Deleted
- `Views/Ladder/LadderView.swift` - Replaced by OrgChartView
- `Views/Ladder/TrackLadderView.swift` - Functionality merged into OrgChartView

### File Modified
**`ContentView.swift`** (line 354)
```swift
// Before:
LadderView(game: game, ladder: campaignConfig.ladder, ...)

// After:
OrgChartView(game: game, ladder: campaignConfig.ladder, ...)
```

---

## Bug Fix: Multiple Position Display

### Problem
Player was shown as filling 6 positions simultaneously on the Ladder view (all bureau positions at the same index).

### Root Cause
Position checking logic used `position.track` (CareerTrack: "shared", "capital", "regional") instead of `position.expandedTrack` (ExpandedCareerTrack: specific bureau like "securityServices").

Since all 6 specialized positions at index 2 have `track = .capital`, they ALL matched when checking `position.track == game.currentCareerTrack`.

### Solution
**File Modified:** `Models/Game.swift`

Added new property:
```swift
var currentExpandedTrack: String = "shared"  // ExpandedCareerTrack.rawValue
```

Added computed property:
```swift
var playerExpandedTrack: ExpandedCareerTrack {
    ExpandedCareerTrack(rawValue: currentExpandedTrack) ?? .shared
}
```

Position checks now use `expandedTrack` for precise bureau matching.

---

## Files Summary

### Created
| File | Purpose |
|------|---------|
| `Views/Ladder/OrgChartView.swift` | Main tree visualization |
| `Views/Ladder/OrgChartNode.swift` | Position box components |
| `Views/Ladder/OrgChartConnector.swift` | Connection line components |

### Modified
| File | Changes |
|------|---------|
| `Views/Desk/BriefingPaperView.swift` | Added ClickableNarrativeText |
| `ContentView.swift` | Changed LadderView to OrgChartView |
| `Models/Game.swift` | Added currentExpandedTrack property |

### Deleted
| File | Reason |
|------|--------|
| `Views/Ladder/LadderView.swift` | Replaced by OrgChartView |
| `Views/Ladder/TrackLadderView.swift` | Merged into OrgChartView |

---

## Build Verification

- Clean build succeeded with no errors
- App launched successfully in iPhone 17 Simulator
- Org chart view renders correctly with scrollable tree structure

---

## Testing Recommendations

1. **Clickable Names:**
   - Start new game or load existing
   - View briefing papers on Desk
   - Verify character names are underlined and tappable
   - Confirm tapping opens character info sheet

2. **Org Chart:**
   - Navigate to LADDER tab
   - Verify top-down tree structure displays correctly
   - Check player's position shows "★ YOU" badge
   - Confirm player's track is highlighted in red
   - Test horizontal/vertical scrolling
   - Tap positions to view detail sheets
   - Verify Regional track appears as separate side branch

3. **Position Fix:**
   - Confirm player only appears in ONE position, not multiple
