# Nomenklatura Development Session #007
**Date:** 2025-12-18

---

## Summary

This session focused on **three major improvements**:
1. **ReactionsSection Component** - New multi-character reactions system showing diverse responses to player decisions
2. **Faction-Based Reactions** - Different factions react differently based on their ideology and the decision type
3. **Duplicate Promotion Bug Fix** - Fixed bug where promotion actions appeared multiple times in Personal Action Phase

---

## Phase 1: ReactionsSection Component

### New Feature
Created a multi-character reactions system that shows how different parts of society respond to player decisions on the Outcome screen.

**File:** `Views/Outcome/ReactionsSection.swift` (NEW)

### Design Goals

Based on user mockup showing:
- Horizontal scrollable reaction cards
- Character portraits with names
- Disposition indicators (checkmark for allies, warning for rivals)
- Italicized reaction quotes

### Data Model

```swift
struct CharacterReactionItem: Identifiable {
    let id = UUID()
    let character: GameCharacter
    let reaction: String
    let reactionType: ReactionType

    enum ReactionType {
        case approval      // Supports the decision
        case disapproval   // Opposes the decision
        case concern       // Worried about consequences
        case neutral       // Observational
    }
}
```

### Reaction Sources (4 Types)

| Source | Who Reacts | When They Appear |
|--------|-----------|------------------|
| **Government/Elite** | Patron or high-ranking officials | Always (for significant decisions) |
| **Faction Members** | Characters from affected factions | Based on decision archetype |
| **Popular Voice** | Synthetic workers ("Worker Anya", "Citizen Dmitri") | Decisions affecting food, stability, popular support |
| **Rivals** | Your political rival | Power moves, investigations, standing changes |

### Character Selection Logic

```swift
// Government reactor - prioritizes patron
private func selectGovernmentReactor(from characters: [GameCharacter], archetype: OptionArchetype) -> GameCharacter? {
    if let patron = game.patron, patron.isAlive {
        return patron
    }
    // Then look for high-ranking officials
    let officials = characters.filter { char in
        char.currentRole == .leader ||
        char.title?.lowercased().contains("minister") == true ||
        char.title?.lowercased().contains("secretary") == true
    }
    return officials.first
}
```

### ReactionCard Component

Visual card showing:
- Character portrait (80px, rounded corners)
- Name with tappable link + disposition indicator
- Reaction quote in italicized typewriter font
- Background matching theme parchment

```swift
struct ReactionCard: View {
    let item: CharacterReactionItem
    let game: Game

    var body: some View {
        VStack(alignment: .leading, spacing: 10) {
            CharacterPortrait(name: item.character.name, size: 80)
            HStack(spacing: 4) {
                TappableName(name: item.character.name, game: game)
                dispositionIndicator
            }
            Text("\"\(item.reaction)\"")
                .font(.custom("AmericanTypewriter", size: 13))
                .italic()
        }
        .frame(width: 150)
        .padding(12)
        .background(theme.parchmentDark)
    }
}
```

---

## Phase 2: Faction-Based Reactions

### Feature
Each of the 5 factions now reacts differently to decisions based on their ideology and interests.

### Faction Ideologies

| Faction | Values | Approves Of | Disapproves Of |
|---------|--------|-------------|----------------|
| **Old Guard** | Ideological purity, security, vigilance | Repression, surveillance, loyalty tests | Reform, compromise, softness |
| **Reformists** | Pragmatism, efficiency, gradual change | Reform, negotiation, economic rationality | Heavy-handed methods |
| **Princelings** | Revolutionary heritage, military strength | Military action, decisive force | Weakness, ignoring military |
| **Youth League** | Merit, procedure, competence | Proper process, orderly administration | Bypassing procedures |
| **Regional** | Local autonomy, provincial needs | Decentralization, resource sharing | Centralization |

### Decision-to-Faction Mapping

```swift
private func getAffectedFactions(for archetype: OptionArchetype) -> [(factionId: String, stance: FactionStance)] {
    switch archetype {
    // Security/Repression - Old Guard approves, Reformists disapprove
    case .repress, .investigate, .surveil:
        return [("old_guard", .approve), ("reformists", .disapprove)]

    // Reform/Liberalization - Reformists approve, Old Guard disapproves
    case .reform, .appease:
        return [("reformists", .approve), ("old_guard", .disapprove)]

    // Military action - Princelings approve, Reformists concerned
    case .military, .mobilize, .attack:
        return [("princelings", .approve), ("reformists", .concerned)]

    // Centralization vs Regional autonomy
    case .administrative, .governance:
        return [("youth_league", .approve), ("regional", .disapprove)]
    // ... additional mappings
    }
}
```

### Faction-Specific Reaction Text

Each faction has unique voice and concerns:

**Old Guard (Security/Ideology):**
```swift
case .approve:
    return ("The organs of state security stand ready. Vigilance protects the Revolution.", .approval)
case .disapprove:
    return ("Softness invites counter-revolution. The ideological foundations must not be weakened.", .disapproval)
```

**Reformists (Pragmatism):**
```swift
case .approve:
    return ("A pragmatic approach. This is how socialism advancesâ€”carefully, methodically.", .approval)
case .disapprove:
    return ("Such methods belong to an earlier era. We must modernize our approach.", .disapproval)
```

**Princelings (Military/Heritage):**
```swift
case .approve:
    return ("The armed forces stand behind this decision. Strength preserves the Revolution.", .approval)
case .disapprove:
    return ("The revolutionary heritage demands better. Our fathers fought for more than this.", .disapproval)
```

**Youth League (Meritocracy):**
```swift
case .approve:
    return ("Proper procedure followed, proper results achieved. This is how it should be.", .approval)
case .disapprove:
    return ("The procedures exist for reasons. Bypassing them sets a dangerous precedent.", .disapproval)
```

**Regional (Provincial Interests):**
```swift
case .approve:
    return ("The provinces will benefit from this. Volkhrad finally understands our needs.", .approval)
case .disapprove:
    return ("Volkhrad does not understand conditions here. This will fail in the provinces.", .disapproval)
```

### FactionStance Enum

```swift
private enum FactionStance {
    case approve
    case disapprove
    case concerned
    case neutral
}
```

---

## Phase 3: Duplicate Promotion Bug Fix

### Problem
The Personal Action Phase showed 5+ identical "Seek promotion to Instructor of the Central Committee" actions instead of just one.

### Root Cause
The career ladder has **7 positions at each index** (one per expanded career track). The promotion generation code was:
1. Finding ALL positions at indices above the player's current position
2. Not filtering by the player's current career track
3. Creating duplicate actions for positions at the same index

### Solution

**File:** `Services/PersonalActionGenerator.swift`

**Before:**
```swift
let positionsAbove = ladder.filter { $0.index > currentIndex && $0.index <= currentIndex + 2 }

for position in positionsAbove {
    if game.standing >= position.requiredStanding {
        actions.append(PersonalAction(
            id: "seek_promotion_\(position.index)",
            // ... duplicates created for all tracks
        ))
    }
}
```

**After:**
```swift
let currentPosition = ladder.first { $0.index == currentIndex }
let currentTrack = currentPosition?.expandedTrack ?? .shared

// Filter to player's current track only
let positionsAbove = ladder.filter { position in
    position.index > currentIndex &&
    position.index <= currentIndex + 2 &&
    (position.expandedTrack == currentTrack ||
     position.expandedTrack == .shared ||
     currentTrack == .shared)
}

// Prevent duplicates at same index
var addedPositionIndices: Set<Int> = []

for position in positionsAbove {
    guard !addedPositionIndices.contains(position.index) else { continue }

    if game.standing >= position.requiredStanding {
        actions.append(PersonalAction(
            id: "seek_promotion_\(position.expandedTrack.rawValue)_\(position.index)",
            // ... unique per track and index
        ))
        addedPositionIndices.insert(position.index)
    }
}
```

### Key Changes

1. **Track filtering** - Only show promotions within player's current career track
2. **Deduplication set** - `addedPositionIndices` prevents multiple actions for same level
3. **Unique IDs** - Action IDs now include track name for true uniqueness

---

## Phase 4: OutcomeView Integration

### Changes
Integrated ReactionsSection into the existing OutcomeView.

**File:** `Views/Outcome/OutcomeView.swift`

### State Changes

**Before:**
```swift
@State private var showReaction = false
```

**After:**
```swift
@State private var showReactions = false
```

### View Changes

**Before:**
```swift
// Single character reaction
if showReaction, let reaction = characterReaction {
    CharacterReactionCard(
        characterName: reaction.character.name,
        reaction: reaction.reaction,
        // ... single character
    )
}
```

**After:**
```swift
// Multi-character reactions section
if showReactions {
    ReactionsSection(
        game: game,
        statChanges: statChanges,
        optionArchetype: optionArchetype
    )
    .transition(.opacity.combined(with: .scale(scale: 0.95)))
}
```

### Animation Timing

Reactions section appears with staggered animation:
1. Outcome narrative (0.5s)
2. **Reactions section** (0.6s delay)
3. Stat changes (1.1s delay)
4. Continue button (1.6s delay)

---

## Files Summary

### New Files

| File | Description |
|------|-------------|
| `Views/Outcome/ReactionsSection.swift` | Multi-character faction-based reactions component |

### Modified Files

| File | Changes |
|------|---------|
| `Views/Outcome/OutcomeView.swift` | Replaced single CharacterReactionCard with ReactionsSection |
| `Services/PersonalActionGenerator.swift` | Fixed duplicate promotion actions bug |

---

## Build Verification

```
** BUILD SUCCEEDED **
```

All changes compiled successfully and were tested in the iOS Simulator.

---

## Visual Reference

### ReactionsSection Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ‘¥  REACTIONS                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [Portrait]â”‚  â”‚ [Portrait]â”‚  â”‚ [Portrait]â”‚  â”‚ [Portrait]â”‚â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚â”‚
â”‚  â”‚ Name  âœ“  â”‚  â”‚ Name  âš   â”‚  â”‚ Name  â”€  â”‚  â”‚ Name  âœ“  â”‚â”‚
â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚  â”‚          â”‚â”‚
â”‚  â”‚ "Quote   â”‚  â”‚ "Quote   â”‚  â”‚ "Quote   â”‚  â”‚ "Quote   â”‚â”‚
â”‚  â”‚  text"   â”‚  â”‚  text"   â”‚  â”‚  text"   â”‚  â”‚  text"   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  [Patron]      [Old Guard]   [Reformist]   [Worker]    â”‚
â”‚  â† Horizontal Scroll â†’                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Reaction Flow Example

**Decision:** REPRESS (crack down on dissidents)

| Character | Faction | Reaction |
|-----------|---------|----------|
| Gen. Secretary Volkov | Government | "Efficient work, comrade. The state appreciates your decisiveness." |
| Dir. Petrov | Old Guard | "The organs of state security stand ready. Vigilance protects the Revolution." |
| Min. Federov | Reformists | "Such methods belong to an earlier era. We must modernize our approach." |
| Worker Anya | Popular | "We cannot sustain this pace. The people are exhausted." |

---

## Technical Notes

### Popular Voice Characters

Synthetic characters created for "voice of the people" reactions:
- Worker Anya, Worker Dmitri, Citizen Marta, Worker Ivan, Citizen Elena
- Assigned `.subordinate` role and "Factory Worker" title
- Disposition set to 50 (neutral)

### Reaction Triggering

Reactions shown when:
- `optionArchetype` is provided to OutcomeView
- At least one character qualifies to react
- Game has living characters in relevant roles/factions

### Performance

- Maximum 4 reactions shown (prevents overflow)
- Character IDs tracked to prevent duplicates
- Lazy loading via horizontal ScrollView

---

## Next Steps

1. Add character portrait images for reaction cards
2. Consider pre-decision reaction preview (show who will react before choosing)
3. Add cumulative memory - factions remember past decisions
4. Sound effects for reaction card appearance
5. Test with all 23 decision archetypes
