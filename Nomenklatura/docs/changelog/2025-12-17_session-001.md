# Nomenklatura Development Session #006
**Date:** 2025-12-17

---

## Summary

This session focused on **four major improvements**:
1. **Key Relations Bug Fix** - Character relationships now compute dynamically based on faction, personality, and position
2. **Policy Initialization** - All 27 policy slots now initialize at game start (not first turn)
3. **ClassifiedOperationCard Component** - New dark cinematic UI for high-stakes SPB operations
4. **SPB Integration** - ClassifiedOperationCard integrated into DENOUNCE, INVESTIGATE, and CULTIVATE flows

---

## Phase 1: Key Relations System Fix

### Problem
All characters showed the same 3 people in their "Key Relations" section (Kadaris, Kozlov, Sokolov) regardless of which character was viewed. The relationships were based on player-centric data (disposition towards player) instead of character-to-character relationships.

### Solution
Rewrote `getRelatedCharacters()` in `CharacterCardView.swift` to compute dynamic, character-specific relationships.

**File:** `Views/Dossier/CharacterCardView.swift`

### Relationship Types Now Computed

| Relationship | Logic |
|--------------|-------|
| **Patron** | Character's `protectorId` points to this NPC |
| **ProtÃ©gÃ©** | Other NPCs whose `protectorId` points to this character |
| **Faction Ally** | Same faction + high faction loyalty (60+) |
| **Close Ally** | Same faction + very high faction loyalty (80+) |
| **Competitor** | Same position track + both ambitious (60+) |
| **Bitter Rival** | Same track + extremely ambitious (80+) |
| **Faction Rival** | Opposing factions + ambitious |
| **Trusted Friend** | Both have high loyalty personality (70+) |
| **Threat** | Ruthless (75+) + ambitious antagonist |

### Faction Opposition Mapping

```swift
private func getOpposingFactions(_ factionId: String) -> [String] {
    switch factionId {
    case "reformists": return ["old_guard", "princelings"]
    case "old_guard": return ["reformists", "youth_league"]
    case "youth_league": return ["old_guard", "princelings"]
    case "princelings": return ["reformists", "youth_league"]
    case "regional": return ["princelings"]
    default: return []
    }
}
```

### Key Changes

1. **Variable count** - Characters can have 0 to many relationships (not always 3)
2. **Unique per character** - Relationships computed from actual character data
3. **Grid layout** - Uses `LazyVGrid` for flexible display
4. **Relationship count shown** - Header shows "(N)" count of relationships

---

## Phase 2: Policy Initialization at Game Start

### Problem
Policies were only initialized during `processPoliticalAI()` on the first turn, meaning the CODEX showed "No policies for this institution" until Turn 1 was processed.

### Solution
Added policy initialization to `startNewGame()` in `ContentView.swift`.

**File:** `ContentView.swift`

### Changes

```swift
// Initialize policies for all bureaus/institutions
PolicyService.shared.initializePolicies(for: newGame)
for slot in newGame.policySlots {
    modelContext.insert(slot)
}
```

### Policy Structure

**27 Policy Slots across 8 Institutions:**

| Institution | Policy Count | Example Policies |
|-------------|--------------|------------------|
| Presidium | 4 | Leadership Selection, Term Limits, Emergency Powers, Succession |
| Congress | 3 | Session Frequency, Delegate Selection, Legislative Power |
| Military | 4 | Political Commissars, Defense Budget, Officer Promotion, Nuclear Authority |
| State Security (SPB) | 3 | Surveillance Scope, Arrest Authority, Internal Investigations |
| Economic Planning | 4 | Enterprise Management, Private Enterprise, Foreign Trade, Price Controls |
| Regional Governance | 3 | Governor Appointment, Regional Autonomy, Resource Revenue |
| Propaganda & Media | 3 | Press Control, Cultural Policy, Religious Policy |
| Foreign Affairs | 3 | Alliance Policy, Border Policy, International Organizations |

---

## Phase 3: ClassifiedOperationCard Component

### New Component
Created a dark, cinematic card UI for high-stakes classified operations.

**File:** `Views/Components/ClassifiedOperationCard.swift`

### Visual Design

Based on user-provided mockup featuring:
- Dark teal/gray background (`#1A2634`, `#243447`, `#2D4052`)
- "TOP SECRET" stamp overlay with red accent
- Cinematic image placeholder with operation-type icons
- Projected outcomes as colored pill badges
- Risk assessment bar with gradient fill
- Cost indicator (political capital)
- DISMISS and EXECUTE ORDER buttons
- Security level footer

### Data Model

```swift
struct ClassifiedOperation: Identifiable {
    let id: UUID
    let decisionNumber: String        // e.g., "#8492"
    let ministry: String              // e.g., "STATE PROTECTION BUREAU"
    let operationName: String         // e.g., "SILENT FALL"
    let imageRef: String?             // e.g., "SPB_OPS_1.47"
    let imageName: String?            // Asset name
    let briefingText: String          // Intelligence briefing
    let projectedOutcomes: [OperationOutcome]
    let cost: Int                     // Political capital
    let riskLevel: OperationRiskLevel // MINIMAL/LOW/MODERATE/HIGH/CRITICAL
    let failureProbability: Int       // 0-100
    let securityLevel: Int            // 1-10
    let operationType: OperationType
}
```

### Supporting Types

```swift
struct OperationOutcome: Identifiable {
    let stat: String      // e.g., "LOYALTY", "FEAR"
    let change: Int       // Positive or negative
    let isPositive: Bool  // For color coding
}

enum OperationRiskLevel: String {
    case minimal, low, moderate, high, critical
}

enum OperationType: String {
    case spbOperation, militaryAction, purge, foreignOperation, crisisResponse, blackOperation
}
```

---

## Phase 4: SPB Integration

### Integration Points
ClassifiedOperationCard integrated into all three character action flows.

**File:** `Views/Dossier/CharacterCardView.swift`

### New State Variables

```swift
@State private var showingClassifiedOperation = false
@State private var pendingDenounceOperation: CharacterInteraction?
@State private var pendingInvestigateOperation: CharacterInteraction?
@State private var pendingCultivateOperation: CharacterInteraction?
@State private var classifiedOperationType: ClassifiedOpType = .denounce

enum ClassifiedOpType {
    case denounce
    case investigate
    case cultivate
}
```

### Flow Change

**Before:**
1. User selects option from sheet
2. Action executes immediately
3. Result shown

**After:**
1. User selects option from sheet
2. ClassifiedOperationCard appears (full screen, dark overlay)
3. User reviews operation details, risk, and outcomes
4. DISMISS cancels, EXECUTE ORDER proceeds
5. Action executes and result shown

### Operation Type Differences

| Feature | DENOUNCE | INVESTIGATE | CULTIVATE |
|---------|----------|-------------|-----------|
| Ministry | STATE PROTECTION BUREAU | INTELLIGENCE DIRECTORATE | DIPLOMATIC LIAISON OFFICE |
| Operation Type | spbOperation | spbOperation | foreignOperation |
| Image Prefix | SPB_OPS | INT_SUR | DIP_OPS |
| Default Outcomes | +FEAR, -STANDING | +INTEL, +NETWORK | +TRUST, +DISPOSITION |

### Operation Name Generation

Each operation type generates thematically appropriate names:

**DENOUNCE:**
```swift
let prefixes = ["IRON", "SILENT", "RED", "WINTER", "STEEL", "CRIMSON", "MIDNIGHT", "BLACK"]
let suffixes = ["FALL", "THUNDER", "HAMMER", "CURTAIN", "GUARD", "PURGE", "JUDGMENT", "STORM"]
// Example: "OPERATION: CRIMSON PURGE"
```

**INVESTIGATE:**
```swift
let prefixes = ["SHADOW", "GHOST", "NIGHT", "SILENT", "DEEP", "COLD", "HIDDEN", "DARK"]
let suffixes = ["WATCH", "EYE", "LENS", "MIRROR", "VEIL", "PROBE", "SEARCH", "TRAIL"]
// Example: "OPERATION: SHADOW LENS"
```

**CULTIVATE:**
```swift
let prefixes = ["GOLDEN", "VELVET", "SILVER", "WARM", "OPEN", "TRUSTED", "FRIENDLY", "SUBTLE"]
let suffixes = ["BRIDGE", "HAND", "DOOR", "PATH", "ACCORD", "BOND", "CHANNEL", "EMBRACE"]
// Example: "OPERATION: GOLDEN ACCORD"
```

### Risk Calculation

```swift
let failureProbability: Int = {
    switch interaction.riskLevel {
    case .low: return Int.random(in: 15...35)
    case .medium: return Int.random(in: 35...55)
    case .high: return Int.random(in: 55...85)
    }
}()
```

### Cost Conversion

Action Points converted to Political Capital:
```swift
cost: interaction.costAP * 25  // 1 AP = 25 CAP
```

---

## Files Summary

### New Files

| File | Description |
|------|-------------|
| `Views/Components/ClassifiedOperationCard.swift` | Dark cinematic card for SPB operations |

### Modified Files

| File | Changes |
|------|---------|
| `Views/Dossier/CharacterCardView.swift` | Key Relations fix, ClassifiedOpType enum, fullScreenCover integration, operation conversion |
| `ContentView.swift` | Policy initialization at game start |

---

## Build Verification

```
** BUILD SUCCEEDED **
```

All changes compiled successfully and were tested in the iOS Simulator.

---

## Usage Examples

### ClassifiedOperationCard Direct Usage

```swift
ClassifiedOperationCard(
    operation: ClassifiedOperation(
        decisionNumber: "#8492",
        ministry: "STATE PROTECTION BUREAU",
        operationName: "SILENT FALL",
        briefingText: "Intelligence suggests a mole in the Ministry...",
        projectedOutcomes: [
            OperationOutcome(stat: "LOYALTY", change: -20, isPositive: false),
            OperationOutcome(stat: "FEAR", change: 15, isPositive: true)
        ],
        cost: 50,
        riskLevel: .high,
        failureProbability: 75
    ),
    onDismiss: { /* handle dismiss */ },
    onExecute: { /* handle execute */ }
)
```

### Testing the Flows

1. **DENOUNCE:** DOSSIER â†’ Character â†’ DENOUNCE â†’ Select option â†’ "STATE PROTECTION BUREAU" card
2. **INVESTIGATE:** DOSSIER â†’ Character â†’ INVESTIGATE â†’ Select option â†’ "INTELLIGENCE DIRECTORATE" card
3. **CULTIVATE:** DOSSIER â†’ Character â†’ CULTIVATE â†’ Select option â†’ "DIPLOMATIC LIAISON OFFICE" card

---

## Visual Reference

### ClassifiedOperationCard Layout

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â‰¡     DAILY BRIEFING        ğŸ””        â”‚
â”‚         Dec 17, 2025                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DECISION #1847    STATE PROTECTION...  â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  OPERATION:                  â”‚TOP     â”‚ â”‚
â”‚  CRIMSON THUNDER             â”‚SECRET  â”‚ â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚     [Operation Image/Icon]      â”‚   â”‚
â”‚  â”‚                                 â”‚   â”‚
â”‚  â”‚   SPB_OPS_1.47                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  TARGET: Minister Volkov               â”‚
â”‚                                        â”‚
â”‚  Intelligence suggests connections     â”‚
â”‚  to reformist elements...              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PROJECTED OUTCOMES                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚-20 LOYALTYâ”‚  â”‚+15 FEAR  â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                        COST: 50 CAP   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  RISK ASSESSMENT              HIGH RISKâ”‚
â”‚  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘          â”‚
â”‚  â”€â”€â”€â”€â”€              Failure: 75%      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  âœ• DISMISS  â”‚  â”‚ âœ EXECUTE ORDER â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚      RESTRICTED ACCESS // LEVEL 5      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Next Steps

1. Add cinematic images for different operation types
2. Integrate ClassifiedOperationCard into military actions
3. Add sound effects for operation confirmation
4. Consider animation transitions for card appearance
5. Test with actual gameplay scenarios
