# Nomenklatura Development Session #002
**Date:** 2025-12-14

---

## Summary

Completed Phase 8 of the Bureau-Specific NPC Actions, Standing Committee & Laws UI implementation plan. This session focused on implementing NPC Law Behavior - allowing Standing Committee NPCs to autonomously propose law changes that benefit their factions.

---

## Phase 8: NPC Law Behavior Implementation

### 1. New NPC Action Type: `proposeLawChange`
**File Modified:** `Services/CharacterAgencyService.swift`

Added a new action to the `NPCActionType` enum:
- **Case:** `.proposeLawChange` (line 3179)
- **Position Requirement:** 7+ (Standing Committee membership)
- **Icon:** `building.columns.fill`
- **Accent Color:** `sovietRed`
- **Description:** "proposing law modifications"

---

### 2. Action Availability Logic
**File Modified:** `Services/CharacterAgencyService.swift`

Updated `getAvailableActionsForNPC()` (lines 864-870):
```swift
if actorPosition >= 7 {
    actions.append(.setNationalPriority)
    // Standing Committee members can propose law changes
    if game.standingCommittee?.memberIds.contains(actor.templateId) ?? false {
        actions.append(.proposeLawChange)
    }
}
```

---

### 3. Action Weight Modifiers
**File Modified:** `Services/CharacterAgencyService.swift`

Added weight bonuses for `proposeLawChange`:

| Condition | Weight Bonus |
|-----------|--------------|
| Ambitious personality (>60) | +20 |
| Competent personality (>60) | +15 |
| SC membership + position 7+ | +25 |
| Low power needs (<40) | +20 + urgency |
| Low recognition needs (<40) | +15 + urgency |

---

### 4. Law Selection Algorithm
**File Modified:** `Services/CharacterAgencyService.swift`

Added new helper function `selectBeneficialLawChange()` (lines 2031-2093):

**Selection Logic:**
1. Gets NPC's faction and faction name
2. Iterates through all laws in `game.laws`
3. Checks if faction is in law's `beneficiaries` array → proposes strengthening
4. Checks if faction is in law's `losers` array → proposes weakening/abolishing
5. Applies faction-specific ideology preferences:
   - Reformist factions prefer weakening economic laws
   - Old Guard prefers strengthening institutional laws

**Priority System:**
- Priority 3: Fixing disadvantages (faction is a loser)
- Priority 2: Strengthening benefits (faction is a beneficiary)
- Priority 1: Ideological preferences

**Duplicate Prevention:**
- Filters out laws already in pending agenda

---

### 5. Action Execution Logic
**File Modified:** `Services/CharacterAgencyService.swift`

Updated `executeNPCAction()` case for `.proposeLawChange` (lines 1617-1629):
```swift
case .proposeLawChange:
    // NPC proposes a law change beneficial to their faction
    relationship.trust = min(100, relationship.trust + 5)

    // Select a law and state change that benefits the NPC's faction
    if let (law, newState) = selectBeneficialLawChange(for: actor, game: game) {
        _ = StandingCommitteeService.shared.proposeLawChange(
            law: law,
            newState: newState,
            sponsor: actor,
            game: game
        )
    }
```

---

### 6. Target Selection
**File Modified:** `Services/CharacterAgencyService.swift`

Added target selection for `.proposeLawChange` (lines 1293-1297):
- Targets another Standing Committee member to consult (optional)
- Filters targets by SC membership

---

### 7. Relationship Effects
**File Modified:** `Services/CharacterAgencyService.swift`

- Builds trust with consulted SC members (+5 trust)
- Relationship effects primarily handled by the voting outcome

---

### 8. Narrative Generation
**File Modified:** `Services/CharacterAgencyService.swift`

Added narrative case (lines 1980-1984):
```swift
case .proposeLawChange:
    return (
        "Law Proposal Submitted",
        "\(actor.name) has submitted a proposal to modify the legal code to the Standing Committee.\n\nThe agenda item will be debated at the next committee session. This could reshape the foundations of state power."
    )
```

---

### 9. Needs Fulfillment
**File Modified:** `Services/CharacterAgencyService.swift`

Updated `updateNeedsAfterAction()` (lines 2728-2730):
```swift
case .proposeLawChange:
    needs.power = min(100, needs.power + 20) // Major legislative impact
    needs.recognition = min(100, needs.recognition + 15)
```

---

### 10. Enum Property Updates
**File Modified:** `Services/CharacterAgencyService.swift`

Added all required enum cases for `NPCActionType`:

| Property | Value |
|----------|-------|
| `iconName` | `"building.columns.fill"` |
| `accentColor` | `"sovietRed"` |
| `actionDescription` | `"proposing law modifications"` |
| `actorPerspective` | `"Proposed law"` |
| `targetPerspective` | `"Law proposed"` |
| `dispositionEffect` | `0` (neutral) |
| `historyDescription` | `"Proposed law change to Standing Committee"` |
| `category` | `.leadership` |
| `requiredPosition` | `7` |

---

## Bug Fix

### LawState String Comparison
**File Modified:** `Services/CharacterAgencyService.swift`

Fixed type mismatch in `selectBeneficialLawChange()`:
- `law.currentState` is stored as `String` (rawValue), not `LawState` enum
- Added conversion: `guard let currentState = LawState(rawValue: currentStateRaw) else { continue }`

---

## Build Verification

- Clean build succeeded with no errors
- All Congress view files confirmed compiling:
  - `CongressTabView.swift`
  - `LawsView.swift`
  - `LawCard.swift`
  - `LawProposalSheet.swift`
  - `StandingCommitteeView.swift`
  - `SessionsView.swift`

---

## Project Structure Note

Confirmed project uses `PBXFileSystemSynchronizedRootGroup` (Xcode 16+ feature):
- Files in `Nomenklatura/` folder are automatically included in build
- No manual project file manipulation required for new files

---

## App Launch

Successfully built and launched app in iPhone 17 Pro Simulator.

---

## Complete Implementation Plan Status

| Phase | Description | Status |
|-------|-------------|--------|
| 1 | Refactor Bureau Action Filtering to use ExpandedCareerTrack enum | Completed |
| 2 | Create Congress UI Shell (CongressTabView, header, sub-tab bar) | Completed |
| 3 | Create Laws sub-tab (LawsView, LawCard, LawProposalSheet) | Completed |
| 4 | Create Standing Committee sub-tab | Completed |
| 5 | Create Sessions sub-tab | Completed |
| 6 | Implement Standing Committee Elections system | Completed |
| 7 | Connect Laws to Standing Committee voting | Completed |
| 8 | Implement NPC Law Behavior | Completed |

**All 8 phases of the implementation plan are now complete.**

---

## Files Modified This Session

| File | Lines Changed |
|------|---------------|
| `Services/CharacterAgencyService.swift` | ~150 lines added/modified |

---

## Testing Recommendations

1. Advance game to turn where Standing Committee exists
2. Verify NPCs at position 7+ with SC membership can select `proposeLawChange`
3. Check that proposed laws appear in pending agenda
4. Verify faction-appropriate law selections (beneficiaries/losers logic)
5. Confirm law proposals go through SC voting at next meeting
