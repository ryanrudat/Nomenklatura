# Session Changelog: 2025-12-23 Session 001

## Overview

This session focused on implementing **clickable character names** throughout all narrative text in the game. When players see character names in memorandums, reports, briefings, and other documents, they can now tap on them to view character details. Unknown characters (detected via title patterns like "Deputy Minister Graham") are automatically created as placeholder characters.

---

## Features Implemented

### 1. Clickable Character Names in All Narratives

**Goal:** Make all character names mentioned in documents clickable so players can tap to see more details.

**User Decision:** When asked how to handle unknown characters (names not in the game database), the user chose **"Auto-create placeholder characters"** - meaning dynamically generate character entries when names are detected and tapped.

---

## Technical Implementation

### Phase 1: Enhanced ClickableNarrativeText (Previously Completed)

**File:** `Views/Components/ClickableNarrativeText.swift`

- Added Soviet/bureaucratic title patterns array (sorted longest-first for regex matching):
  ```swift
  private static let titlePatterns: [String] = [
      "Deputy Minister", "Vice Minister", "Assistant Minister",
      "Deputy Director", "Assistant Director",
      "First Secretary", "Deputy Secretary", "General Secretary",
      "Deputy Chairman", "Vice Chairman",
      "Deputy Commissar", "Vice Commissar",
      "Lieutenant General", "Major General", "Lieutenant Colonel",
      "Minister", "Director", "Comrade", "Citizen",
      "General", "Colonel", "Major", "Captain", "Lieutenant",
      "Secretary", "Chairman", "Commissar", "Marshal",
      "Ambassador", "Inspector", "Governor", "Chief",
      "Professor", "Doctor", "Academician"
  ]
  ```

- Added regex pattern matching: `\b(Title)\s+([A-Z][a-z]+)(?:\s+([A-Z][a-z]+))?\b`

- Updated `TextSegment` enum:
  ```swift
  enum TextSegment {
      case text(String)
      case characterName(String)       // Known character
      case potentialCharacter(String)  // Detected via title, not in game yet
  }
  ```

- Added `newcharacter://` URL scheme for unknown names
- Added `.createAndShowCharacter` notification

### Phase 2: CharacterSheetOverlay Auto-Creation (Previously Completed)

**File:** `Views/Components/ClickableNarrativeText.swift`

- Added `@Environment(\.modelContext)` for persistence
- Added `createPlaceholderCharacter(from:)` method:
  ```swift
  private func createPlaceholderCharacter(from fullName: String) -> GameCharacter {
      let (title, name) = parsePotentialCharacter(fullName)
      let character = GameCharacter(
          name: name,
          title: title,
          role: .neutral,
          introducedTurn: game.turnNumber,
          disposition: 50
      )
      character.wasDiscoveredDynamically = true
      character.isFullyRevealed = false
      // Random personality traits (hidden until revealed)
      character.personalityAmbitious = Int.random(in: 30...70)
      // ... more traits
      return character
  }
  ```

- Handles `.createAndShowCharacter` notification to create and persist placeholder characters

### Phase 3: UNVERIFIED Badge for Placeholders (Previously Completed)

**File:** `Views/Components/TappableName.swift`

Added visual indicator for dynamically discovered characters:
```swift
if character.wasDiscoveredDynamically && !character.isFullyRevealed {
    HStack(spacing: 4) {
        Image(systemName: "questionmark.circle")
            .font(.system(size: 10))
        Text("UNVERIFIED")
            .font(.system(size: 9, weight: .bold))
            .tracking(0.5)
    }
    .foregroundColor(Color(hex: "5D4037"))
    .padding(.horizontal, 6)
    .padding(.vertical, 2)
    .background(Color(hex: "5D4037").opacity(0.1))
    .cornerRadius(2)
}
```

### Phase 4: View Updates (This Session)

#### FallenCharactersView.swift (Previously Completed)
- Added `game: Game` parameter to `FallenCharactersView`, `FallenGroupSection`, `FallenCharacterCard`
- Replaced `Text(narrative)` with `ClickableNarrativeText`
- Added `.characterSheetOverlay(game: game)` modifier

#### DossierView.swift (Previously Completed)
- Updated call site: `FallenCharactersView(characters: fallen, game: game)`

#### CharacterCardView.swift (This Session)
- Updated 6 narrative `Text()` calls to use `ClickableNarrativeText`:
  - `interactionResultCard` - result narratives (2 locations)
  - `leaderResultCard` - leader action narratives
  - `InteractionButton` - interaction descriptions
  - `CharacterHistoryEventRow` - event narratives
- Added `game: Game` parameter to `CharacterHistoryEventRow`
- Updated call site to pass `game`

#### SessionsView.swift (This Session)
- Added `game: Game` parameter to `DecisionRow` struct
- Updated call site: `DecisionRow(decision: decision, game: game)`
- Replaced `Text(decision.narrativeSummary)` with `ClickableNarrativeText`

#### ClassifiedOperationCard.swift (This Session)
- Added `let game: Game` parameter to `ClassifiedOperationCard`
- Replaced `Text(operation.briefingText)` with `ClickableNarrativeText`
- Updated both preview blocks with sample `Game(campaignId: "coldwar")`
- Updated call site in `CharacterCardView.swift` to pass `game`

---

## Files Modified

| File | Changes |
|------|---------|
| `Views/Components/ClickableNarrativeText.swift` | Title pattern detection, auto-creation logic |
| `Views/Components/TappableName.swift` | UNVERIFIED badge in CharacterQuickInfoSheet |
| `Views/Dossier/FallenCharactersView.swift` | Added game param, ClickableNarrativeText |
| `Views/Dossier/DossierView.swift` | Updated FallenCharactersView call |
| `Views/Dossier/CharacterCardView.swift` | 6 narrative updates, CharacterHistoryEventRow game param |
| `Views/Congress/SessionsView.swift` | DecisionRow game param, ClickableNarrativeText |
| `Views/Components/ClassifiedOperationCard.swift` | Added game param, updated briefing section |

---

## How the Feature Works

### Known Characters
- Names appear **underlined** in disposition-based colors:
  - **Green** - Patron or friendly (disposition >= 70)
  - **Red** - Rival or hostile (disposition <= 30)
  - **Black** - Neutral
- Tapping opens the character's dossier sheet

### Unknown Characters (Title + Name Patterns)
- Detected via regex matching Soviet/bureaucratic titles
- Appear in **sepia/brown** color with **dashed underline**
- Examples: "Deputy Minister Graham", "Comrade Peterson", "Colonel Volkov"

### Auto-Creation on Tap
1. Player taps an unknown name like "Deputy Minister Graham"
2. System creates a `GameCharacter` with:
   - `name: "Graham"`
   - `title: "Deputy Minister"`
   - `wasDiscoveredDynamically: true`
   - `isFullyRevealed: false`
   - Random personality traits (hidden)
   - Neutral disposition (50)
3. Character is persisted to SwiftData
4. Dossier sheet opens showing "UNVERIFIED" badge

---

## Build Status

**BUILD SUCCEEDED** - All changes compile and the app runs in the simulator.

---

## Not Completed / Future Work

1. **Testing in Live Gameplay** - The feature is implemented but needs real gameplay testing to verify:
   - Title pattern detection works across all narrative text
   - Placeholder characters persist correctly
   - No duplicate characters created for same name
   - Character sheet overlay properly intercepts taps

2. **Promotion System Testing** - From the previous session context, the promotion system was connected but not fully tested:
   - `PositionOfferService.processTurn()` added to GameEngine
   - Position offer event response handler created in DeskView
   - Vacancy tracking added to CharacterFateService

3. **Revealing Placeholder Characters** - Currently placeholders stay "UNVERIFIED" forever. Future work could:
   - Add events that reveal personality traits
   - Allow investigating unknown characters
   - Connect discovered characters to faction networks

---

## Session Statistics

- **Duration:** ~1 hour
- **Files Modified:** 7
- **Lines Changed:** ~150
- **Build Result:** Success
