# Session Changelog: 2025-12-19 Session 002

## Focus: Performance Optimization & Game Balance Framework

### Performance Optimizations (Phase A)

#### 1. JSON Decode Caching in Game.swift
Added `@Transient` cached properties for all JSON-encoded Data fields:
- `pendingDynamicEvents` - cached decoded events
- `dynamicEventCooldowns` - cached cooldown dictionary
- `pendingProjects` - cached projects
- `activeShowTrials` - cached show trials
- `earnedBadges` - cached badges
- `trackAffinityScores` - cached affinity data
- `activePlotThreads` / `resolvedPlotThreads` - cached plot threads

**Impact**: Eliminates redundant JSON decoding on every property access. Each property now decodes once and caches until modified.

#### 2. Shared JSONEncoder/Decoder
Added static shared instances:
```swift
private static let sharedDecoder = JSONDecoder()
private static let sharedEncoder = JSONEncoder()
```
**Impact**: Reduces memory allocation overhead from creating new coders per operation.

#### 3. Computed Property Memoization
- `aggregatedPolicyEffects` now cached with `invalidatePolicyCache()` method
- `patron` and `primaryRival` now cached with `invalidateCharacterRoleCaches()` method
- Added `invalidateAllCaches()` convenience method for turn starts

#### 4. Character Filter Memoization in DossierView
Moved filter logic to computed properties:
```swift
private var activeCharacters: [GameCharacter]
private var fallenCharacters: [GameCharacter]
private var filteredCharacters: [GameCharacter]
```
**Impact**: Reduces redundant array filtering operations in the figures tab.

### Game Balance Framework (Phase B)

#### 1. Created BalanceConfig.swift
New centralized configuration file at `Config/BalanceConfig.swift` with tunable parameters:

**Event Pacing**:
- `quietTurnChance`, `earlyGameQuietBonus`, `crisisQuietPenalty`
- `forceQuietAfterEventTurns`

**Rival Balance**:
- `rivalActionBaseChance`, `rivalActionMaxChance`
- `rivalEventCooldown`, `rivalAggressiveThreshold`

**Patron Balance**:
- `patronWarningThreshold`, `patronCriticalThreshold`
- `patronFavorDecayPerTurn`, `patronEventCooldown`

**Stat Effect Caps**:
- `maxNationalStatChange`, `maxPersonalStatChange`

**Game Over Thresholds**:
- `assassinationRivalThreat`, `assassinationNetworkThreshold`
- `revolutionStabilityThreshold`, `revolutionPopularSupportThreshold`
- `coupMilitaryLoyaltyThreshold`, `coupStabilityThreshold`
- `territorialCollapseRegions`

**Progression**:
- `actionPointsPerTurn`, `maxInteractionsPerTurn`

**Debug Helpers**:
- `resetToDefaults()` - restore original values
- `printCurrentConfig()` - log current configuration

#### 2. Updated Services to Use BalanceConfig

**DynamicEventTriggerService.swift**:
- `calculateRivalActionChance()` uses `BalanceConfig.rivalActionBaseChance/MaxChance`
- `shouldBeQuietTurn()` uses `BalanceConfig.quietTurnChance/earlyGameQuietBonus/crisisQuietPenalty`

**GameOverCondition.swift**:
- `checkRevolution()` uses `BalanceConfig.revolutionStabilityThreshold/PopularSupportThreshold`
- `checkAssassination()` uses `BalanceConfig.assassinationRivalThreat/NetworkThreshold`
- `checkMilitaryCoup()` uses `BalanceConfig.coupStabilityThreshold/MilitaryLoyaltyThreshold`
- `checkTerritorialDisintegration()` uses `BalanceConfig.territorialCollapseRegions`

### AI End-to-End Testing (Phase C)

#### 1. Added Diagnostic Logging
Enhanced `AIScenarioGenerator.generateFromAI()` with metrics:
```swift
[AI] SUCCESS | Duration: 5.23s | Input: 2450 tokens | Output: 1200 tokens
```
- Tracks API call duration
- Logs actual token usage from response
- Logs validation failures with reasons

#### 2. Verified AI Integration
- API key configured in Secrets.swift
- Build compiles with all changes
- App launches successfully in simulator
- Ready for manual playtesting

### Files Modified

| File | Changes |
|------|---------|
| `Models/Game.swift` | Added @Transient caches, shared coders, memoized properties |
| `Views/Dossier/DossierView.swift` | Memoized character filter properties |
| `Config/BalanceConfig.swift` | NEW - centralized balance configuration |
| `Services/DynamicEventTriggerService.swift` | Updated to use BalanceConfig |
| `Models/GameOverCondition.swift` | Updated to use BalanceConfig |
| `Services/AI/AIScenarioGenerator.swift` | Added diagnostic logging |

### Testing Recommendations

**Performance Testing**:
1. Open Dossier > Figures tab with 50+ characters
2. Toggle filter buttons rapidly - should feel snappy
3. Play through 10+ turns - turn transitions should be fast
4. Monitor memory usage during extended play

**Balance Testing**:
1. Play early game (turns 1-10) - verify ~60% quiet turns
2. Build up high rival threat (70+) - verify increased events
3. Let patron favor drop below 35 - verify warnings trigger
4. Approach game over thresholds - verify conditions trigger correctly

**AI Testing** (run from Xcode to see logs):
1. Start new game with AI enabled
2. Watch console for `[AI]` logs on turn 2+
3. Verify scenarios are contextually relevant
4. Disable AI (Secrets.swift) and verify fallback works
