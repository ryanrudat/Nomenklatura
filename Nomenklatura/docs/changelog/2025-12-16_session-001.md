# Nomenklatura Development Session #005
**Date:** 2025-12-16

---

## Summary

This session focused on **three bug fixes** from user testing and implementing **position-appropriate event filtering** to ensure players receive decisions appropriate for their rank in the Party hierarchy.

---

## Phase 1: Bug Fixes from User Testing

### Fix 1: Clickable Names in Dynamic Event View

**Problem:** Character names in scenario/briefing text on the Desk view were not clickable.

**File:** `Views/Desk/DynamicEventView.swift`

**Changes:**
```swift
// Before:
Text(event.briefText)
    .font(theme.narrativeFont)
    .foregroundColor(theme.inkBlack)

// After:
ClickableNarrativeText(
    text: event.briefText,
    game: game,
    font: theme.narrativeFont,
    color: theme.inkBlack,
    lineSpacing: 6
)
```

Also added `CharacterSheetOverlayModifier` to handle tap events.

---

### Fix 2: Real-World References Removed

**Problem:** Text contained real-world geographic references (Africa, Asia, Europe) instead of fictional world names.

**Files Modified:**
- `Services/InitialAgendaGenerator.swift`
- `Services/NewspaperGenerator.swift`

**Changes:**

| Original | Updated |
|----------|---------|
| "Africa and Asia" | "the Commonwealth colonies" |
| "Southeast Asia" | "the Commonwealth colonies" |
| "Western Europe" | "Korvath and Brechtland" |
| "African nations" | "Commonwealth territories" |
| "Soviet society" | "Volkerian society" |

Uses proper fictional country names from WORLD_BUILDING.md:
- **Commonwealth of Islands** - Colonial power with "fading imperial glory"
- **Korvath** - Continental capitalist democracy
- **Brechtland** - Industrial capitalist state

---

### Fix 3: Repetitive Event Spam ("Seeks Advancement")

**Problem:** The same NPC event (e.g., "Nurzhan Amanzhol Seeks Advancement") appeared 5-6 times in a row.

**File:** `Services/GoalDrivenAgencyService.swift`

**Changes Added:**

1. **Game-level cooldown check:**
```swift
if game.isEventTypeOnCooldown(.characterMessage) {
    return []
}
```

2. **Pacing requirement:**
```swift
if game.lastDynamicEventTurn > 0 && game.turnNumber - game.lastDynamicEventTurn < 2 {
    return []
}
```

3. **Per-character cooldown (4 turns):**
```swift
if let lastTurn = character.lastInitiatedTurn, game.turnNumber - lastTurn < 4 {
    continue
}
```

4. **Goal type variety tracking:**
```swift
private var recentGoalTypes: [NPCGoalType] = []
private let maxRecentGoalTypes = 5

// Skip if this goal type was used recently
if recentGoalTypes.contains(primaryGoal.goalType) {
    return nil
}
```

5. **Shuffle NPCs for variety:**
```swift
let npcsWithGoals = game.characters.filter { ... }.shuffled()
```

---

### Fix 4: Blank Character Sheet on Name Tap

**Problem:** Clicking on character names showed a blank sheet or "Character not found".

**File:** `Views/Components/ClickableNarrativeText.swift`

**Changes:**

1. Changed from `sheet(isPresented:)` to `sheet(item:)` pattern - sheet only opens when character is found

2. Added partial name matching:
```swift
private func findCharacter(named name: String, in game: Game) -> GameCharacter? {
    // Try exact match first
    if let character = game.characters.first(where: {
        $0.name.lowercased() == name.lowercased()
    }) {
        return character
    }
    // Try partial match (e.g., "Volkov" matches "Minister Volkov")
    if let character = game.characters.first(where: {
        $0.name.lowercased().contains(name.lowercased()) ||
        name.lowercased().contains($0.name.lowercased())
    }) {
        return character
    }
    return nil
}
```

3. Updated both `CharacterSheetOverlay` and `CharacterSheetOverlayModifier` with the fix.

---

## Phase 2: Position-Appropriate Event Filtering

**Goal:** Ensure players receive decisions appropriate for their rank. A junior official shouldn't get national policy crises that only bureau heads would handle.

### Position Hierarchy Reference

| Index | Level | Example Positions |
|-------|-------|-------------------|
| 0 | Entry | Party Official |
| 1 | Junior | Junior Presidium Member |
| 2-3 | Rising | Deputy Head, Instructor |
| 4-5 | Senior | Department Head, Minister |
| 6-7 | Top | Deputy General Secretary |
| 8 | Apex | General Secretary |

---

### Change 1: ScenarioCategory Position Requirements

**File:** `Models/Scenario.swift`

**Added Properties:**

```swift
/// Minimum position index required for this category
var minimumPositionIndex: Int {
    switch self {
    case .introduction: return 0
    case .routineDay, .characterMoment: return 0
    case .tensionBuilder: return 1
    case .routine, .newspaper: return 0
    case .opportunity: return 1
    case .character: return 1
    case .crisis: return 2  // Real crises only for those with responsibility
    }
}

/// Maximum position index (nil = no max)
var maximumPositionIndex: Int? {
    switch self {
    case .introduction: return 1  // Only for entry positions
    case .routineDay: return 4    // Senior officials don't do paperwork
    default: return nil
    }
}

/// Check if appropriate for position
func isAppropriate(forPositionIndex index: Int) -> Bool
```

---

### Change 2: DynamicEventType Position Requirements

**File:** `Models/DynamicEvent.swift`

**Added Properties:**

```swift
var minimumPositionIndex: Int {
    switch self {
    case .ambientTension, .worldNews: return 0
    case .characterMessage: return 1
    case .networkIntel: return 2
    case .allyRequest: return 2
    case .rivalAction: return 2
    case .patronDirective: return 1
    case .characterSummons: return 2
    case .consequenceCallback: return 0
    case .urgentInterruption: return 3  // Major crises need authority
    }
}

var maximumPositionIndex: Int? {
    switch self {
    case .ambientTension: return 5  // Senior officials get direct reports
    default: return nil
    }
}
```

---

### Change 3: Service-Level Filtering

**File:** `Services/GoalDrivenAgencyService.swift`

```swift
if let event = evaluateCharacterGoals(character, game: game) {
    // Filter by player position
    guard event.eventType.isAppropriate(forPositionIndex: game.currentPositionIndex) else {
        continue
    }
    events.append(event)
}
```

**File:** `Services/DynamicEventTriggerService.swift`

```swift
// Filter by player position - ensure events are appropriate for their rank
let positionFiltered = candidates.filter { event in
    event.eventType.isAppropriate(forPositionIndex: game.currentPositionIndex)
}

// Then filter by cooldowns
let filtered = filterByCooldowns(positionFiltered, game: game)
```

---

### Change 4: AI Prompt Position Guidance

**File:** `Services/AI/ScenarioPromptBuilder.swift`

**Added `getPositionScopeGuidance()` function:**

| Position | Scope Description |
|----------|-------------------|
| 0 (Entry) | Paperwork, office politics, proving yourself to superiors |
| 1 (Junior) | Local governance, small crises, seeking patron favor |
| 2-3 (Rising) | Regional matters, subordinate management, factional politics |
| 4-5 (Senior) | Ministry affairs, Politburo interaction, personnel decisions |
| 6-7 (Top) | National policy, Standing Committee, succession politics |
| 8 (GS) | Supreme authority, foreign relations, legacy |

**Example for Entry Level:**
```
**Position Scope:** ENTRY LEVEL - You are a minor Party official. Your decisions involve:
- Paperwork and administrative duties within your small office
- Managing relationships with immediate colleagues and superiors
- Navigating petty office politics and bureaucratic procedures
- Proving yourself worthy of notice from those above you
DO NOT give this player national policy decisions or access to senior leadership.
```

**Category selection also filters by position:**
```swift
let decisionCategories: [ScenarioCategory] = [.crisis, .routine, .opportunity, .character]
    .filter { $0.isAppropriate(forPositionIndex: game.currentPositionIndex) }
```

---

## Files Summary

### Modified Files

| File | Changes |
|------|---------|
| `Views/Desk/DynamicEventView.swift` | Added ClickableNarrativeText for character names |
| `Views/Components/ClickableNarrativeText.swift` | Fixed character lookup, sheet(item:) pattern |
| `Services/InitialAgendaGenerator.swift` | Replaced real-world with fictional geography |
| `Services/NewspaperGenerator.swift` | Replaced real-world with fictional geography |
| `Services/GoalDrivenAgencyService.swift` | Anti-spam cooldowns, position filtering |
| `Services/DynamicEventTriggerService.swift` | Position-based event filtering |
| `Models/Scenario.swift` | Added position requirements to ScenarioCategory |
| `Models/DynamicEvent.swift` | Added position requirements to DynamicEventType |
| `Services/AI/ScenarioPromptBuilder.swift` | Position scope guidance for AI |

---

## Build Verification

```
** BUILD SUCCEEDED **
```

---

## Key Implementation Details

### Position Filtering Flow

1. **AI Generation:** ScenarioPromptBuilder only selects categories appropriate for position
2. **AI Guidance:** Prompt includes detailed scope description for player's level
3. **Event Generation:** GoalDrivenAgencyService filters events by position
4. **Event Triggering:** DynamicEventTriggerService filters all candidates by position

### Anti-Spam Protections

| Protection | Cooldown |
|------------|----------|
| Event type cooldown | Game-level check |
| Turn pacing | 2+ turns between goal events |
| Per-character | 4 turns before same NPC contacts again |
| Goal type variety | Track last 5 goal types, skip repeats |
| NPC shuffle | Random order prevents same NPC dominating |

---

## Next Steps

1. Test clickable character names in game
2. Verify position-appropriate events at different ranks
3. Test AI scenario generation with position guidance
4. Verify anti-spam protections work correctly
