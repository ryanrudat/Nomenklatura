# Session Changelog: 2025-12-27 Session 001

## Overview

This session implemented **interactive sparkline graphs** and a **career timeline** with a vintage 1950s aesthetic. The personal stats widget now displays real-time trend sparklines, and a new career timeline view shows the player's journey through the Party apparatus.

Additionally, this session included bug fixes for duplicate events/memos, balance improvements for patron favor decay, rank-appropriate document language, and lore consolidation.

---

## Tasks Completed

### 1. Stat History Tracking System

**Goal:** Track historical values of all stats for sparkline visualization.

**File:** `Models/Game.swift`

**Implementation:**
- Added `Data` properties for all personal stats (standing, network, patronFavor, rivalThreat)
- Added `Data` properties for all national stats (stability, popularSupport, treasury, etc.)
- Created computed property accessors with JSON encoding/decoding
- Added `recordAllStatHistory()` function to capture stats at end of turn
- History limited to last 20 turns per stat

```swift
// Personal stat history (for sparklines)
var standingHistoryData: Data?
var networkHistoryData: Data?
var patronFavorHistoryData: Data?
var rivalThreatHistoryData: Data?

var standingHistory: [Int] {
    get {
        guard let data = standingHistoryData else { return [] }
        return (try? JSONDecoder().decode([Int].self, from: data)) ?? []
    }
    set {
        let trimmed = Array(newValue.suffix(20))
        standingHistoryData = try? JSONEncoder().encode(trimmed)
    }
}

func recordAllStatHistory() {
    standingHistory = standingHistory + [standing]
    networkHistory = networkHistory + [network]
    // ... all stats
}
```

---

### 2. Career Event Model

**Goal:** Create a data model for tracking career milestones.

**File:** `Models/CareerEvent.swift` (NEW)

**CareerEventType enum:**
| Type | Icon | Shape | Color |
|------|------|-------|-------|
| joined | star.fill | circle | statHigh |
| promotion | arrow.up.circle.fill | circle | statHigh |
| demotion | arrow.down.circle.fill | diamond | statLow |
| crisis | exclamationmark.triangle.fill | diamond | statLow |
| purge | xmark.seal.fill | diamond | statLow |
| achievement | medal.fill | circle | statHigh |
| patronChange | person.crop.circle.badge.checkmark | square | accentGold |
| rivalChange | person.crop.circle.badge.xmark | square | accentGold |
| characterDeath | cross.fill | cross | statLow |
| policyChange | doc.text.fill | star | primaryText |
| internationalEvent | globe | star | primaryText |

**Factory methods:**
- `gameStartEvent(game:)` - Initial Party joining
- `promotionEvent(game:newPosition:oldPosition:)`
- `demotionEvent(game:newPosition:oldPosition:)`
- `crisisEvent(game:crisisName:description:)`
- `patronEvent(game:patronName:gained:)`
- `rivalEvent(game:rivalName:appeared:)`
- `deathEvent(game:characterName:relationship:)`
- `purgeEvent(game:description:survived:)`
- `achievementEvent(game:achievementName:description:)`

---

### 3. Vintage Sparkline Component

**Goal:** Create a sparkline chart with 1950s graph paper aesthetic.

**File:** `Views/Components/VintageSparklineView.swift` (NEW)

**Visual Elements:**
- Graph paper background with subtle grid lines
- Hand-drawn wobble effect on line paths (deterministic random offsets)
- Color-coded lines based on thresholds:
  - Red (`statLow`) when value < 40
  - Green (`statHigh`) when value > 70
  - Black (typewriterInk) for normal range
- Dashed baseline at 50%
- Trend arrows (up/down/stable)
- Typewriter-style labels ("NOW", "T-10")

**Components Created:**
- `VintageSparklineView` - Compact sparkline for widgets
- `GraphPaperBackground` - Reusable vintage grid pattern
- `HandDrawnSparklinePath` - Path with wobble effect
- `DetailedSparklineView` - Large chart for detail sheets
- `TrendArrow` - Small directional indicator

---

### 4. Sparkline Stat Widget

**Goal:** Integrate sparklines into the personal stats display.

**File:** `Views/Components/SparklineStatWidget.swift` (NEW)

**SparklineStatWidget:**
```
┌─────────────────┐
│      [icon]     │
│       67        │
│   ╭──╮──        │  <- sparkline
│  ─╯  ╰──        │
│    STANDING     │
└─────────────────┘
```

**SparklinePersonalStatsRow:**
- 2x2 grid layout for Standing, Network, Patron Favor, Rival Threat
- Each stat shows current value + sparkline trend
- Tap to open `StatDetailSheet` with full history

**StatDetailSheet:**
- Full-screen stat detail with large chart
- Statistics summary (highest, lowest, average, turns)
- Trend indicator (RISING/FALLING/STABLE)

---

### 5. Career Timeline View

**Goal:** Create an interactive horizontal timeline of career events.

**File:** `Views/Journal/CareerTimelineView.swift` (NEW)

**CareerTimelineView:**
```
═══════════════════════════════════════════════════════►
  │         │              │           │         NOW
  ●         ●              ◆           ★          │
  │         │              │           │          │
Turn 1    Turn 5        Turn 12     Turn 18       │
JOINED    PROMOTED      CRISIS      ACHIEVEMENT   │

[═══════ Standing sparkline underneath ═══════════════]
```

**Features:**
- Horizontal scroll through career history
- Filter bar: ALL | RANK | CRISIS | PEOPLE
- Event markers with different shapes per type
- Standing sparkline running along bottom
- Tap event marker → detail card with stats snapshot
- NOW marker showing current turn

**Supporting Components:**
- `TimelineEventMarker` - Shaped markers for events
- `TimelineSparkline` - Stat trend along timeline
- `CareerTimelineSheet` - Full-screen timeline view
- `CompactTimelineWidget` - Embeddable mini timeline

---

### 6. DeskView Integration

**File:** `Views/Desk/DeskView.swift`

**Change:** Replaced `PersonalStatsWidgetRow` with `SparklinePersonalStatsRow`

```swift
SparklinePersonalStatsRow(
    standing: game.standing,
    network: game.network,
    patronFavor: game.patronFavor,
    rivalThreat: game.rivalThreat,
    standingHistory: game.standingHistory,
    networkHistory: game.networkHistory,
    patronFavorHistory: game.patronFavorHistory,
    rivalThreatHistory: game.rivalThreatHistory,
    onStandingTap: onLadderTap,
    onNetworkTap: onDossierTap,
    onPatronTap: openPatronSheet,
    onRivalTap: openRivalSheet
)
```

---

### 7. GameEngine History Recording

**File:** `Services/GameEngine.swift`

Added history recording at end of turn:

```swift
// Record stat history for sparklines (at end of turn after all processing)
game.recordAllStatHistory()
```

---

### 8. Fix Duplicate Events/Memos (from previous context)

**Problem:** Players getting repeat "urgent" and "memos" within one turn.

**Files Modified:**
- `Services/DynamicEventTriggerService.swift` - Changed patron events to `else if` chain
- `Services/DocumentQueueService.swift` - Added `categoriesGeneratedThisTurn` tracking
- `Models/Game.swift` - Added `isEventTypeOnReducedCooldown` method

---

### 9. Patron Favor Decay Balance (from previous context)

**Problem:** Patron favor constantly decaying felt like a treadmill.

**Solution:** Decay only when patron is neglected (3+ turns without interaction).

**Files Modified:**
- `Models/Game.swift` - Added `lastPatronInteractionTurn` and `isPatronNeglected`
- `Services/GameEngine.swift` - Changed decay to conditional

---

### 10. Rank-Appropriate Document Language (from previous context)

**Problem:** Memos using authority language beyond player's rank.

**File:** `Models/World/AccessLevel.swift`

**Created:** `AuthorityLanguage` struct with position-aware helpers:
- `hasArrestAuthority`, `hasStrategicResourceAuthority`, `hasIntelligenceAuthority`
- `decisionVerb` - "authorize"/"approve"/"endorse"/"recommend" based on position
- `arrestLanguage(target:)`, `resourceLanguage(resource:)`, `intelligenceLanguage(target:)`
- Approval chain context and signature lines

---

### 11. Lore Consolidation (from previous context)

**File:** `WORLD_BUILDING.md`

**Deleted:** Root-level `WORLD_BUILDING.md` (outdated Volkeria version)

**Added to Nomenklatura version:**
- The Lost Territories (Hawaii, Alaska)
- Religion and Cultural Transformation
- Soviet-PSRA Relations
- Regional Ethnic Identities

---

## Files Created

| File | Purpose |
|------|---------|
| `Models/CareerEvent.swift` | Career milestone event model |
| `Views/Components/VintageSparklineView.swift` | Sparkline charts with vintage styling |
| `Views/Components/SparklineStatWidget.swift` | Stat widgets with integrated sparklines |
| `Views/Journal/CareerTimelineView.swift` | Interactive career timeline |

---

## Files Modified

| File | Changes |
|------|---------|
| `Models/Game.swift` | Stat history arrays, `currentPositionName`, patron neglect tracking |
| `Models/World/AccessLevel.swift` | `AuthorityLanguage` struct |
| `Services/GameEngine.swift` | History recording, conditional patron decay |
| `Services/DynamicEventTriggerService.swift` | Fixed duplicate patron events |
| `Services/DocumentQueueService.swift` | Category deduplication, authority language |
| `Services/ScenarioManager.swift` | Position title fix for Turn 1 |
| `Views/Desk/DeskView.swift` | Sparkline stats integration |
| `WORLD_BUILDING.md` | Consolidated and expanded lore |

---

## Files Deleted

| File | Reason |
|------|--------|
| `../WORLD_BUILDING.md` (root) | Outdated Volkeria version, consolidated into Nomenklatura version |

---

## Vintage Design Aesthetic

### Color Palette
| Element | Color | Hex |
|---------|-------|-----|
| Graph paper lines | Faded tan | `#D4C5A9` |
| Background | Parchment | `#F4F1E8` |
| Ink (normal) | Typewriter black | `#2C2416` |
| Ink (danger) | Soviet red | `#8B0000` |
| Ink (good) | Muted green | `#2E5A1C` |

### Typography
- Labels: Monospace (Courier-style)
- Trend labels: "NOW", "T-10", "RISING", "STABLE"
- All caps for headers

### Effects
- Graph paper grid
- Hand-drawn wobble on paths (±0.8pt random offset)
- Dashed baseline at 50%
- Subtle ink bleed shadow

---

## Git Commits

1. `e060c31` - Add interactive sparkline graphs and career timeline with vintage aesthetic

---

## Session Statistics

- **Files Created:** 4
- **Files Modified:** 8
- **Files Deleted:** 1
- **Lines Changed:** +2,724, -378
- **Git Commits:** 1
- **Build Status:** Successful
