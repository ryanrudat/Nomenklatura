# Session Changelog: 2025-12-24 Session 001

## Overview

This session focused on **securing the Anthropic API key** by setting up a GitHub repository and deploying a backend proxy server to Render. The API key is no longer embedded in the iOS app—it's now stored securely server-side.

---

## Tasks Completed

### 1. GitHub Repository Setup

**Goal:** Version control for the Nomenklatura project.

**Steps:**
1. Initialized git repository in `/Users/ryanrudat/Desktop/Nomenklatura`
2. Created public GitHub repository: `ryanrudat/Nomenklatura`
3. Verified `.gitignore` excludes `**/Secrets.swift`
4. Fixed `Secrets.example` to use placeholder instead of real API key (GitHub push protection caught this)
5. Pushed initial commit (220 files, 119,433 lines)

**Repository URL:** https://github.com/ryanrudat/Nomenklatura

---

### 2. API Proxy Server

**Goal:** Secure the Anthropic API key by moving it server-side.

**Problem:** The API key was hardcoded in `Secrets.swift`, visible in compiled binaries and extractable via reverse engineering.

**Solution:** Created a simple Node.js/Express proxy server that:
- Holds the API key as an environment variable
- Forwards requests from the iOS app to Anthropic
- Returns responses to the iOS app

**Files Created:**

| File | Purpose |
|------|---------|
| `proxy/package.json` | Node.js dependencies (Express) |
| `proxy/index.js` | Proxy server code |
| `proxy/render.yaml` | Render deployment config |
| `proxy/.gitignore` | Excludes node_modules and .env |

**Proxy Endpoints:**
- `GET /` - Health check, returns `{"status":"ok","service":"nomenklatura-proxy"}`
- `GET /health` - Health check
- `POST /api/messages` - Proxies requests to Anthropic Claude API

---

### 3. Render Deployment

**Goal:** Deploy the proxy to Render's $7/month Starter tier.

**Configuration:**
- **Service Name:** nomenklatura-proxy
- **Root Directory:** proxy
- **Build Command:** npm install
- **Start Command:** npm start
- **Environment Variable:** `ANTHROPIC_API_KEY` (set in Render dashboard)

**Proxy URL:** https://nomenklatura-proxy.onrender.com

**Verification:** Tested successfully with curl:
```bash
curl -X POST https://nomenklatura-proxy.onrender.com/api/messages \
  -H "Content-Type: application/json" \
  -d '{"model":"claude-sonnet-4-5-20250929","max_tokens":50,"messages":[{"role":"user","content":"Say hello"}]}'
```
Response: `"Hello! How are you?"`

---

### 4. iOS App Updates

**Goal:** Configure the app to use the proxy instead of direct API access.

**Files Modified:**

#### ClaudeClient.swift
- Changed `baseURL` to use `Secrets.proxyURL`
- Added conditional logic for API key header (only sent in direct API mode)

```swift
// Use proxy URL in production, direct API for local development
private let baseURL = Secrets.proxyURL

// Only add API key header for direct API access (local development)
if Secrets.useDirectAPI {
    request.addValue(Secrets.anthropicAPIKey, forHTTPHeaderField: "x-api-key")
    request.addValue("2023-06-01", forHTTPHeaderField: "anthropic-version")
}
```

#### Secrets.swift / Secrets.example
- Added `proxyURL` configuration
- Added `useDirectAPI` toggle (false = use proxy, true = direct API)
- Updated `isAIEnabled` logic to check appropriate config

```swift
enum Secrets: Sendable {
    // MARK: - Production (Proxy)
    static let proxyURL = "https://nomenklatura-proxy.onrender.com/api/messages"
    static let useDirectAPI = false

    // MARK: - Development (Direct API)
    static let anthropicAPIKey = "YOUR_API_KEY_HERE"

    static let isAIEnabled: Bool = {
        if useDirectAPI {
            return anthropicAPIKey != "YOUR_API_KEY_HERE" && !anthropicAPIKey.isEmpty
        } else {
            return proxyURL != "https://YOUR-RENDER-APP.onrender.com/api/messages"
        }
    }()
}
```

---

## Files Modified

| File | Changes |
|------|---------|
| `proxy/package.json` | NEW - Node.js project config |
| `proxy/index.js` | NEW - Express proxy server |
| `proxy/render.yaml` | NEW - Render deployment config |
| `proxy/.gitignore` | NEW - Git ignore for proxy |
| `Nomenklatura/Config/Secrets.swift` | Added proxy URL, useDirectAPI toggle |
| `Nomenklatura/Config/Secrets.example` | Updated template with proxy config |
| `Nomenklatura/Services/AI/ClaudeClient.swift` | Use proxy URL, conditional headers |

---

## Security Improvements

| Before | After |
|--------|-------|
| API key hardcoded in app | API key stored in Render environment variable |
| Key visible in compiled binary | Key never leaves server |
| Key exposed in Secrets.example | Template uses placeholder |
| GitHub push blocked by secret detection | Clean push with no secrets |

---

## Architecture

```
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│                 │         │                 │         │                 │
│    iOS App      │ ──────► │  Render Proxy   │ ──────► │  Anthropic API  │
│  (no API key)   │         │ (holds API key) │         │                 │
│                 │ ◄────── │                 │ ◄────── │                 │
└─────────────────┘         └─────────────────┘         └─────────────────┘
```

---

## Remaining Tasks

1. **Rotate API Key** - The old key was exposed in git history and session logs. Rotate it at https://console.anthropic.com
2. **Test in Xcode** - Build and run the app to verify proxy integration works in-game

---

## Git Commits

1. `5a9e2ac` - Initial commit: Nomenklatura political simulation game (amended to remove secret)
2. `636b2fb` - Initial commit (fixed, pushed)
3. `cd25b5e` - Add API proxy server for Render deployment
4. `0efe567` - Update iOS app to support proxy configuration

---

## Session Statistics

- **Duration:** ~45 minutes
- **Files Created:** 4
- **Files Modified:** 3
- **Git Commits:** 4
- **Proxy Status:** Deployed and verified
